# 时间序列分析

> 使用 Python 进行时间序列数据处理和分析

## 1. 时间序列概述

时间序列是按时间顺序排列的数据序列，常见应用：
- 股票价格预测
- 销售预测
- 天气预测
- 用户行为分析

## 2. 时间序列数据处理

### 2.1 创建时间序列

```python
import pandas as pd
import numpy as np

# 创建日期范围
dates = pd.date_range('2024-01-01', periods=100, freq='D')

# 创建时间序列
ts = pd.Series(np.random.randn(100), index=dates)

# 从DataFrame创建
df = pd.DataFrame({
    'date': dates,
    'value': np.random.randn(100)
})
df['date'] = pd.to_datetime(df['date'])
df.set_index('date', inplace=True)
```

### 2.2 时间序列索引

```python
# 按年份索引
ts['2024']

# 按月份索引
ts['2024-01']

# 按日期范围
ts['2024-01-01':'2024-01-31']

# 使用loc
ts.loc['2024-01-01':'2024-01-31']
```

### 2.3 重采样

```python
# 降采样（日 -> 周）
weekly = ts.resample('W').mean()

# 升采样（日 -> 小时）
hourly = ts.resample('H').ffill()

# 自定义聚合
monthly = ts.resample('M').agg(['mean', 'sum', 'max'])
```

## 3. 时间序列特征

### 3.1 趋势分析

```python
# 移动平均
ts.rolling(window=7).mean()  # 7日移动平均
ts.rolling(window=30).mean()  # 30日移动平均

# 指数移动平均
ts.ewm(span=7).mean()

# 趋势分解
from statsmodels.tsa.seasonal import seasonal_decompose

decomposition = seasonal_decompose(ts, model='additive')
trend = decomposition.trend
seasonal = decomposition.seasonal
residual = decomposition.resid
```

### 3.2 季节性分析

```python
# 检测季节性
from statsmodels.tsa.stattools import acf

autocorr = acf(ts, nlags=30)

# 季节性分解
decomposition = seasonal_decompose(ts, period=12)
```

### 3.3 平稳性检验

```python
from statsmodels.tsa.stattools import adfuller

def test_stationarity(timeseries):
    result = adfuller(timeseries)
    print('ADF统计量:', result[0])
    print('p值:', result[1])
    print('临界值:', result[4])
    
    if result[1] <= 0.05:
        print("序列是平稳的")
    else:
        print("序列不是平稳的")

test_stationarity(ts)
```

## 4. 时间序列预测

### 4.1 ARIMA 模型

```python
from statsmodels.tsa.arima.model import ARIMA

# 拟合ARIMA模型
model = ARIMA(ts, order=(1, 1, 1))
fitted_model = model.fit()

# 预测
forecast = fitted_model.forecast(steps=10)
print(forecast)
```

### 4.2 Prophet 模型

```python
from prophet import Prophet

# 准备数据
df_prophet = pd.DataFrame({
    'ds': dates,
    'y': ts.values
})

# 创建模型
model = Prophet()
model.fit(df_prophet)

# 预测
future = model.make_future_dataframe(periods=30)
forecast = model.predict(future)
```

### 4.3 LSTM 预测

```python
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense

def create_sequences(data, seq_length):
    X, y = [], []
    for i in range(len(data) - seq_length):
        X.append(data[i:i+seq_length])
        y.append(data[i+seq_length])
    return np.array(X), np.array(y)

# 准备数据
seq_length = 10
X, y = create_sequences(ts.values, seq_length)

# 构建模型
model = Sequential([
    LSTM(50, activation='relu', input_shape=(seq_length, 1)),
    Dense(1)
])
model.compile(optimizer='adam', loss='mse')

# 训练
model.fit(X, y, epochs=50, verbose=0)
```

## 5. 时间序列可视化

### 5.1 基础可视化

```python
import matplotlib.pyplot as plt

# 绘制时间序列
ts.plot(figsize=(12, 6))
plt.title('时间序列图')
plt.xlabel('日期')
plt.ylabel('值')
plt.show()

# 绘制移动平均
ts.plot(label='原始数据')
ts.rolling(7).mean().plot(label='7日移动平均')
ts.rolling(30).mean().plot(label='30日移动平均')
plt.legend()
plt.show()
```

### 5.2 分解图

```python
decomposition.plot()
plt.show()
```

## 6. 异常检测

### 6.1 统计方法

```python
# Z-score方法
mean = ts.mean()
std = ts.std()
z_scores = (ts - mean) / std
anomalies = ts[abs(z_scores) > 3]

# IQR方法
Q1 = ts.quantile(0.25)
Q3 = ts.quantile(0.75)
IQR = Q3 - Q1
anomalies = ts[(ts < Q1 - 1.5*IQR) | (ts > Q3 + 1.5*IQR)]
```

## 7. 总结

时间序列分析要点：
- **数据处理**：创建、索引、重采样
- **特征分析**：趋势、季节性、平稳性
- **预测模型**：ARIMA、Prophet、LSTM
- **可视化**：时间序列图、分解图
- **异常检测**：统计方法检测异常值

时间序列分析在金融、销售、运营等领域有广泛应用。

