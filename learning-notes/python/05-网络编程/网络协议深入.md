# 网络协议深入

> Python 网络协议编程和底层网络操作

## 1. TCP/UDP 编程

### 1.1 TCP 服务器

```python
import socket

def tcp_server():
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server_socket.bind(('localhost', 8888))
    server_socket.listen(5)
    
    print("TCP服务器启动...")
    while True:
        client_socket, addr = server_socket.accept()
        print(f"客户端连接: {addr}")
        
        data = client_socket.recv(1024)
        print(f"收到数据: {data.decode()}")
        
        client_socket.send(b"Hello from server")
        client_socket.close()

tcp_server()
```

### 1.2 TCP 客户端

```python
def tcp_client():
    client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    client_socket.connect(('localhost', 8888))
    
    client_socket.send(b"Hello from client")
    response = client_socket.recv(1024)
    print(f"收到响应: {response.decode()}")
    
    client_socket.close()

tcp_client()
```

### 1.3 UDP 服务器

```python
def udp_server():
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    server_socket.bind(('localhost', 8888))
    
    print("UDP服务器启动...")
    while True:
        data, addr = server_socket.recvfrom(1024)
        print(f"收到来自 {addr} 的数据: {data.decode()}")
        server_socket.sendto(b"Hello from server", addr)

udp_server()
```

### 1.4 UDP 客户端

```python
def udp_client():
    client_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    
    client_socket.sendto(b"Hello from client", ('localhost', 8888))
    response, addr = client_socket.recvfrom(1024)
    print(f"收到来自 {addr} 的响应: {response.decode()}")
    
    client_socket.close()

udp_client()
```

## 2. HTTP 协议

### 2.1 原始 HTTP 请求

```python
import socket
import ssl

def http_request(host, path="/"):
    # 创建TCP连接
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((host, 80))
    
    # 发送HTTP请求
    request = f"GET {path} HTTP/1.1\r\nHost: {host}\r\n\r\n"
    sock.send(request.encode())
    
    # 接收响应
    response = sock.recv(4096)
    print(response.decode())
    
    sock.close()

http_request("www.example.com")
```

### 2.2 HTTPS 请求

```python
def https_request(host, path="/"):
    context = ssl.create_default_context()
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    ssl_sock = context.wrap_socket(sock, server_hostname=host)
    ssl_sock.connect((host, 443))
    
    request = f"GET {path} HTTP/1.1\r\nHost: {host}\r\n\r\n"
    ssl_sock.send(request.encode())
    
    response = ssl_sock.recv(4096)
    print(response.decode())
    
    ssl_sock.close()

https_request("www.example.com")
```

## 3. DNS 查询

### 3.1 DNS 解析

```python
import socket

def dns_lookup(hostname):
    try:
        ip = socket.gethostbyname(hostname)
        print(f"{hostname} -> {ip}")
    except socket.gaierror:
        print(f"无法解析 {hostname}")

dns_lookup("www.google.com")
```

### 3.2 反向DNS查询

```python
def reverse_dns_lookup(ip):
    try:
        hostname = socket.gethostbyaddr(ip)
        print(f"{ip} -> {hostname[0]}")
    except socket.herror:
        print(f"无法解析 {ip}")

reverse_dns_lookup("8.8.8.8")
```

## 4. 网络扫描

### 4.1 端口扫描

```python
import socket
from concurrent.futures import ThreadPoolExecutor

def scan_port(host, port):
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(1)
        result = sock.connect_ex((host, port))
        sock.close()
        return port if result == 0 else None
    except:
        return None

def port_scan(host, ports):
    with ThreadPoolExecutor(max_workers=100) as executor:
        results = executor.map(lambda p: scan_port(host, p), ports)
        open_ports = [p for p in results if p is not None]
    return open_ports

open_ports = port_scan('localhost', range(1, 1024))
print(f"开放端口: {open_ports}")
```

## 5. 总结

网络协议深入要点：
- **TCP/UDP**：面向连接、无连接协议
- **HTTP/HTTPS**：应用层协议、SSL/TLS
- **DNS**：域名解析、反向查询
- **网络扫描**：端口扫描、并发扫描

深入理解网络协议有助于开发高性能网络应用。

