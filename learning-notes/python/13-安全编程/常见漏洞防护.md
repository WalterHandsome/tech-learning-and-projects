# 常见漏洞防护

> Python 应用安全：常见漏洞和防护措施

## 1. SQL 注入防护

### 1.1 使用参数化查询

```python
# ❌ 不安全
query = f"SELECT * FROM users WHERE id = {user_id}"
cursor.execute(query)

# ✅ 安全
query = "SELECT * FROM users WHERE id = %s"
cursor.execute(query, (user_id,))
```

### 1.2 使用 ORM

```python
# SQLAlchemy自动防护SQL注入
user = session.query(User).filter(User.id == user_id).first()
```

## 2. XSS 防护

### 2.1 转义输出

```python
import html

# 转义HTML
user_input = "<script>alert('XSS')</script>"
safe_output = html.escape(user_input)

# Jinja2自动转义
from jinja2 import escape
safe_output = escape(user_input)
```

## 3. CSRF 防护

### 3.1 使用 CSRF Token

```python
from flask_wtf.csrf import CSRFProtect

app = Flask(__name__)
csrf = CSRFProtect(app)

# 在表单中添加token
<form method="POST">
    {{ csrf_token() }}
    ...
</form>
```

## 4. 命令注入防护

### 4.1 避免使用 shell=True

```python
# ❌ 不安全
subprocess.run(f"ls {user_input}", shell=True)

# ✅ 安全
subprocess.run(['ls', user_input])
```

## 5. 文件上传安全

### 5.1 验证文件类型

```python
import magic

def validate_file(file):
    # 检查MIME类型
    mime = magic.from_buffer(file.read(), mime=True)
    allowed_types = ['image/jpeg', 'image/png']
    if mime not in allowed_types:
        raise ValueError("不允许的文件类型")
    
    # 检查文件扩展名
    allowed_extensions = ['.jpg', '.png']
    if not any(file.filename.endswith(ext) for ext in allowed_extensions):
        raise ValueError("不允许的文件扩展名")
```

## 6. 敏感信息保护

### 6.1 环境变量

```python
import os

# 使用环境变量
api_key = os.getenv('API_KEY')
db_password = os.getenv('DB_PASSWORD')
```

### 6.2 配置文件安全

```python
# 使用python-dotenv
from dotenv import load_dotenv
load_dotenv()

# 不要提交.env文件到Git
```

## 7. 输入验证

### 7.1 数据验证

```python
from pydantic import BaseModel, validator

class UserInput(BaseModel):
    email: str
    age: int
    
    @validator('email')
    def validate_email(cls, v):
        if '@' not in v:
            raise ValueError('无效的邮箱')
        return v
    
    @validator('age')
    def validate_age(cls, v):
        if v < 0 or v > 120:
            raise ValueError('年龄必须在0-120之间')
        return v
```

## 8. 总结

安全防护要点：
- **SQL注入**：参数化查询、ORM
- **XSS**：输出转义
- **CSRF**：Token验证
- **命令注入**：避免shell=True
- **文件上传**：类型验证
- **敏感信息**：环境变量
- **输入验证**：数据验证

多层安全防护确保应用安全。

