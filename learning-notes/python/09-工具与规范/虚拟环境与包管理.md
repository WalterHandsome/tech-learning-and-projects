# 虚拟环境与包管理

> Python 虚拟环境和包管理的最佳实践

## 1. 虚拟环境

### 1.1 venv（标准库）

```bash
# 创建虚拟环境
python -m venv venv

# 激活（Windows）
venv\Scripts\activate

# 激活（Linux/Mac）
source venv/bin/activate

# 停用
deactivate
```

### 1.2 virtualenv

```bash
# 安装
pip install virtualenv

# 创建
virtualenv venv

# 指定Python版本
virtualenv -p python3.10 venv
```

### 1.3 conda

```bash
# 创建环境
conda create -n myenv python=3.10

# 激活
conda activate myenv

# 安装包
conda install numpy pandas

# 导出环境
conda env export > environment.yml
```

## 2. 包管理工具

### 2.1 pip

```bash
# 安装包
pip install package_name

# 安装特定版本
pip install package_name==1.0.0

# 从requirements.txt安装
pip install -r requirements.txt

# 生成requirements.txt
pip freeze > requirements.txt

# 升级包
pip install --upgrade package_name
```

### 2.2 Poetry

```bash
# 安装
pip install poetry

# 初始化项目
poetry init

# 添加依赖
poetry add fastapi uvicorn

# 安装依赖
poetry install

# 更新依赖
poetry update

# 导出requirements.txt
poetry export -f requirements.txt --output requirements.txt
```

### 2.3 pipenv

```bash
# 安装
pip install pipenv

# 创建环境并安装
pipenv install

# 安装开发依赖
pipenv install --dev pytest

# 激活shell
pipenv shell

# 生成requirements.txt
pipenv requirements > requirements.txt
```

## 3. 依赖管理

### 3.1 requirements.txt

```txt
# 精确版本
fastapi==0.104.1
uvicorn==0.24.0

# 版本范围
pydantic>=1.10.0,<2.0.0

# Git依赖
git+https://github.com/user/repo.git@branch

# 本地依赖
./local-package
```

### 3.2 setup.py

```python
from setuptools import setup, find_packages

setup(
    name="myproject",
    version="1.0.0",
    install_requires=[
        "fastapi>=0.100.0",
        "uvicorn>=0.20.0",
    ],
    extras_require={
        "dev": ["pytest", "black", "mypy"],
    },
    packages=find_packages(),
)
```

## 4. 最佳实践

### 4.1 项目结构

```
project/
├── venv/              # 虚拟环境（不提交）
├── requirements.txt    # 生产依赖
├── requirements-dev.txt # 开发依赖
├── setup.py           # 包配置
└── src/
    └── app/
```

### 4.2 依赖锁定

```bash
# 使用pip-tools
pip install pip-tools

# 生成requirements.in
echo "fastapi" > requirements.in

# 编译锁定版本
pip-compile requirements.in

# 更新
pip-compile --upgrade requirements.in
```

## 5. 总结

虚拟环境和包管理要点：
- **虚拟环境**：隔离项目依赖
- **包管理**：pip、Poetry、pipenv
- **依赖文件**：requirements.txt、setup.py
- **版本锁定**：确保环境一致性
- **最佳实践**：分离生产和开发依赖

良好的依赖管理是项目成功的基础。

