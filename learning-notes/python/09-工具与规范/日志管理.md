# 日志管理

> Python 日志记录和管理最佳实践

## 1. 基础日志

### 1.1 简单日志

```python
import logging

logging.basicConfig(level=logging.INFO)
logging.info("这是一条信息")
logging.warning("这是一条警告")
logging.error("这是一条错误")
```

### 1.2 日志级别

```python
logging.debug("调试信息")
logging.info("一般信息")
logging.warning("警告信息")
logging.error("错误信息")
logging.critical("严重错误")
```

## 2. 日志配置

### 2.1 格式化日志

```python
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
```

### 2.2 文件日志

```python
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('app.log'),
        logging.StreamHandler()
    ]
)
```

## 3. 高级日志配置

### 3.1 日志轮转

```python
from logging.handlers import RotatingFileHandler

handler = RotatingFileHandler(
    'app.log',
    maxBytes=10*1024*1024,  # 10MB
    backupCount=5
)
handler.setLevel(logging.INFO)
handler.setFormatter(logging.Formatter(
    '%(asctime)s - %(levelname)s - %(message)s'
))

logger = logging.getLogger()
logger.addHandler(handler)
```

### 3.2 时间轮转

```python
from logging.handlers import TimedRotatingFileHandler

handler = TimedRotatingFileHandler(
    'app.log',
    when='midnight',
    interval=1,
    backupCount=30
)
```

## 4. 结构化日志

### 4.1 JSON 日志

```python
import json
import logging

class JSONFormatter(logging.Formatter):
    def format(self, record):
        log_data = {
            'timestamp': self.formatTime(record),
            'level': record.levelname,
            'message': record.getMessage(),
            'module': record.module,
            'function': record.funcName
        }
        return json.dumps(log_data)

handler = logging.StreamHandler()
handler.setFormatter(JSONFormatter())
logger = logging.getLogger()
logger.addHandler(handler)
logger.setLevel(logging.INFO)

logger.info("结构化日志消息")
```

## 5. 日志上下文

### 5.1 添加上下文信息

```python
import logging

class ContextFilter(logging.Filter):
    def filter(self, record):
        record.user_id = getattr(record, 'user_id', 'unknown')
        record.request_id = getattr(record, 'request_id', 'unknown')
        return True

logger = logging.getLogger()
logger.addFilter(ContextFilter())

# 使用
logger.info("处理请求", extra={'user_id': '123', 'request_id': 'abc'})
```

## 6. 多模块日志

### 6.1 模块日志

```python
# module1.py
logger = logging.getLogger('module1')
logger.info("模块1的日志")

# module2.py
logger = logging.getLogger('module2')
logger.info("模块2的日志")

# 配置
logging.basicConfig(level=logging.INFO)
module1_logger = logging.getLogger('module1')
module1_logger.setLevel(logging.DEBUG)
```

## 7. 总结

日志管理要点：
- **基础日志**：日志级别、格式化
- **日志配置**：文件日志、控制台日志
- **日志轮转**：大小轮转、时间轮转
- **结构化日志**：JSON格式、上下文信息
- **多模块日志**：模块化日志管理

良好的日志管理有助于问题诊断和系统监控。

