# 配置管理

> Python 应用配置管理最佳实践

## 1. 环境变量

### 1.1 python-dotenv

```python
from dotenv import load_dotenv
import os

# 加载.env文件
load_dotenv()

# 读取配置
database_url = os.getenv('DATABASE_URL')
api_key = os.getenv('API_KEY', 'default_value')
debug = os.getenv('DEBUG', 'False').lower() == 'true'
```

### 1.2 .env 文件

```bash
# .env
DATABASE_URL=postgresql://user:pass@localhost/db
API_KEY=your_api_key_here
DEBUG=True
PORT=8000
```

## 2. Pydantic 配置

### 2.1 Settings 类

```python
from pydantic import BaseSettings
from typing import Optional

class Settings(BaseSettings):
    database_url: str
    api_key: str
    debug: bool = False
    port: int = 8000
    log_level: str = "INFO"
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"
        case_sensitive = False

settings = Settings()
```

### 2.2 嵌套配置

```python
from pydantic import BaseSettings

class DatabaseSettings(BaseSettings):
    host: str
    port: int = 5432
    user: str
    password: str
    database: str

class APISettings(BaseSettings):
    key: str
    timeout: int = 30

class Settings(BaseSettings):
    database: DatabaseSettings
    api: APISettings
    
    class Config:
        env_nested_delimiter = "__"

# 环境变量
# DATABASE__HOST=localhost
# DATABASE__PORT=5432
# API__KEY=secret
```

## 3. Django 配置

### 3.1 多环境配置

```python
# settings/base.py
import os
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent

# settings/development.py
from .base import *

DEBUG = True
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# settings/production.py
from .base import *

DEBUG = False
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.getenv('DB_NAME'),
        'USER': os.getenv('DB_USER'),
        'PASSWORD': os.getenv('DB_PASSWORD'),
        'HOST': os.getenv('DB_HOST'),
        'PORT': os.getenv('DB_PORT'),
    }
}
```

## 4. Flask 配置

### 4.1 配置类

```python
import os

class Config:
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-secret-key'
    DATABASE_URI = os.environ.get('DATABASE_URI')
    
class DevelopmentConfig(Config):
    DEBUG = True
    DATABASE_URI = 'sqlite:///dev.db'

class ProductionConfig(Config):
    DEBUG = False
    DATABASE_URI = os.environ.get('DATABASE_URI')

config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}

app.config.from_object(config[os.getenv('FLASK_ENV', 'default')])
```

## 5. 配置文件管理

### 5.1 YAML 配置

```python
import yaml

with open('config.yaml', 'r') as f:
    config = yaml.safe_load(f)

# config.yaml
# database:
#   host: localhost
#   port: 5432
# api:
#   key: secret
```

### 5.2 JSON 配置

```python
import json

with open('config.json', 'r') as f:
    config = json.load(f)
```

### 5.3 TOML 配置

```python
import tomli

with open('config.toml', 'rb') as f:
    config = tomli.load(f)
```

## 6. 配置验证

### 6.1 配置验证

```python
from pydantic import BaseSettings, validator

class Settings(BaseSettings):
    port: int
    host: str
    timeout: int
    
    @validator('port')
    def validate_port(cls, v):
        if not 1 <= v <= 65535:
            raise ValueError('端口必须在1-65535之间')
        return v
    
    @validator('timeout')
    def validate_timeout(cls, v):
        if v < 0:
            raise ValueError('超时时间不能为负数')
        return v
```

## 7. 配置热重载

### 7.1 文件监控

```python
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

class ConfigHandler(FileSystemEventHandler):
    def on_modified(self, event):
        if event.src_path.endswith('config.yaml'):
            reload_config()

observer = Observer()
observer.schedule(ConfigHandler(), path='.', recursive=False)
observer.start()
```

## 8. 总结

配置管理要点：
- **环境变量**：python-dotenv、.env文件
- **Pydantic配置**：Settings类、嵌套配置
- **Django配置**：多环境配置、环境分离
- **Flask配置**：配置类、环境切换
- **配置文件**：YAML、JSON、TOML
- **配置验证**：Pydantic验证器
- **配置热重载**：文件监控、自动重载

良好的配置管理提高应用可维护性。

