# 性能测试与压力测试

> 使用 Python 进行应用性能测试和压力测试

## 1. 性能测试概述

性能测试包括：
- 响应时间测试
- 吞吐量测试
- 并发测试
- 压力测试
- 负载测试

## 2. 使用 Locust 进行压力测试

### 2.1 安装

```bash
pip install locust
```

### 2.2 基础测试

```python
from locust import HttpUser, task, between

class WebsiteUser(HttpUser):
    wait_time = between(1, 3)
    
    @task
    def index_page(self):
        self.client.get("/")
    
    @task(3)
    def view_item(self):
        self.client.get("/item?id=1")
    
    def on_start(self):
        self.client.post("/login", json={"username":"test", "password":"test"})
```

### 2.3 运行测试

```bash
locust -f locustfile.py --host=http://localhost:8000
```

## 3. 使用 pytest-benchmark

### 3.1 基准测试

```python
import pytest

def test_function_performance(benchmark):
    result = benchmark(function_to_test, arg1, arg2)
    assert result is not None

@pytest.mark.benchmark
def test_api_response_time(benchmark):
    response = benchmark(requests.get, "http://localhost:8000/api/users")
    assert response.status_code == 200
```

## 4. 使用 Apache Bench (ab)

### 4.1 命令行测试

```bash
ab -n 1000 -c 10 http://localhost:8000/api/users
```

### 4.2 Python 封装

```python
import subprocess

def run_ab_test(url, requests=1000, concurrency=10):
    cmd = f"ab -n {requests} -c {concurrency} {url}"
    result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
    return result.stdout
```

## 5. 性能分析

### 5.1 响应时间分析

```python
import time
import statistics

def measure_response_time(func, *args, **kwargs):
    times = []
    for _ in range(100):
        start = time.time()
        func(*args, **kwargs)
        times.append(time.time() - start)
    
    return {
        'mean': statistics.mean(times),
        'median': statistics.median(times),
        'p95': statistics.quantiles(times, n=20)[18],
        'p99': statistics.quantiles(times, n=100)[98]
    }
```

## 6. 总结

性能测试要点：
- **Locust**：分布式压力测试
- **pytest-benchmark**：基准测试
- **Apache Bench**：HTTP压力测试
- **性能分析**：响应时间、吞吐量、并发能力

性能测试帮助发现系统瓶颈和优化点。

