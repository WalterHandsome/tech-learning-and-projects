# 内存优化技巧

> Python 内存优化和内存管理

## 1. 内存分析

### 1.1 使用 memory_profiler

```python
from memory_profiler import profile

@profile
def my_function():
    data = [i for i in range(1000000)]
    return sum(data)
```

### 1.2 使用 tracemalloc

```python
import tracemalloc

tracemalloc.start()

# 你的代码
data = [i for i in range(1000000)]

current, peak = tracemalloc.get_traced_memory()
print(f"当前内存: {current / 1024 / 1024:.2f} MB")
print(f"峰值内存: {peak / 1024 / 1024:.2f} MB")

snapshot = tracemalloc.take_snapshot()
top_stats = snapshot.statistics('lineno')
for stat in top_stats[:10]:
    print(stat)
```

## 2. 内存优化技巧

### 2.1 使用生成器

```python
# 列表（占用内存）
data = [i**2 for i in range(1000000)]

# 生成器（节省内存）
data = (i**2 for i in range(1000000))
```

### 2.2 使用 __slots__

```python
class User:
    __slots__ = ['name', 'email']  # 限制属性
    
    def __init__(self, name, email):
        self.name = name
        self.email = email
```

### 2.3 及时释放大对象

```python
def process_large_data():
    large_data = load_large_data()
    result = process(large_data)
    del large_data  # 显式删除
    import gc
    gc.collect()  # 强制垃圾回收
    return result
```

## 3. 数据结构优化

### 3.1 使用 array 模块

```python
import array

# 使用array代替list（数值类型）
numbers = array.array('i', range(1000000))  # 'i'表示整数
```

### 3.2 使用 collections.deque

```python
from collections import deque

# deque比list在两端操作更高效
queue = deque([1, 2, 3])
queue.append(4)
queue.popleft()
```

## 4. 总结

内存优化要点：
- **内存分析**：memory_profiler、tracemalloc
- **生成器**：节省内存
- **__slots__**：减少对象内存
- **及时释放**：del、gc.collect()
- **数据结构**：array、deque

合理的内存管理可以提高应用性能。

