# 监控与日志

> Python 应用监控和日志管理

## 1. 应用监控

### 1.1 Prometheus 监控

```python
from prometheus_client import Counter, Histogram, Gauge, start_http_server

# 计数器
request_count = Counter('http_requests_total', 'Total HTTP requests')

# 直方图
request_duration = Histogram('http_request_duration_seconds', 'HTTP request duration')

# 仪表盘
active_users = Gauge('active_users', 'Number of active users')

# 启动指标服务器
start_http_server(8000)

# 使用
request_count.inc()
request_duration.observe(0.5)
active_users.set(100)
```

### 1.2 健康检查

```python
from fastapi import FastAPI
from fastapi.responses import JSONResponse

app = FastAPI()

@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "database": check_database(),
        "redis": check_redis()
    }

@app.get("/metrics")
async def metrics():
    # 返回Prometheus格式指标
    return metrics_output
```

## 2. 日志聚合

### 2.1 ELK Stack

```python
import logging
from pythonjsonlogger import jsonlogger

# JSON格式日志
logHandler = logging.StreamHandler()
formatter = jsonlogger.JsonFormatter()
logHandler.setFormatter(formatter)

logger = logging.getLogger()
logger.addHandler(logHandler)
logger.setLevel(logging.INFO)

logger.info("应用启动", extra={
    'user_id': '123',
    'action': 'start'
})
```

### 2.2 结构化日志

```python
import structlog

logger = structlog.get_logger()

logger.info(
    "用户登录",
    user_id="123",
    ip_address="192.168.1.1",
    timestamp="2024-01-01T00:00:00Z"
)
```

## 3. 错误追踪

### 3.1 Sentry 集成

```python
import sentry_sdk
from sentry_sdk.integrations.flask import FlaskIntegration

sentry_sdk.init(
    dsn="https://xxx@sentry.io/xxx",
    integrations=[FlaskIntegration()],
    traces_sample_rate=1.0
)

# 自动捕获异常
try:
    result = 1 / 0
except Exception:
    sentry_sdk.capture_exception()
```

### 3.2 自定义错误追踪

```python
import logging
import traceback

def log_error_with_context(error, context=None):
    logger = logging.getLogger('error')
    error_info = {
        'error': str(error),
        'traceback': traceback.format_exc(),
        'context': context or {}
    }
    logger.error("错误发生", extra=error_info)
```

## 4. 性能监控

### 4.1 APM 监控

```python
from elasticapm import Client

apm_client = Client(
    service_name='myapp',
    server_url='http://localhost:8200'
)

# 事务追踪
with apm_client.begin_transaction('request'):
    # 业务逻辑
    process_request()
```

### 4.2 慢查询监控

```python
from sqlalchemy import event
from sqlalchemy.engine import Engine
import time

@event.listens_for(Engine, "before_cursor_execute")
def receive_before_cursor_execute(conn, cursor, statement, parameters, context, executemany):
    conn.info.setdefault('query_start_time', []).append(time.time())

@event.listens_for(Engine, "after_cursor_execute")
def receive_after_cursor_execute(conn, cursor, statement, parameters, context, executemany):
    total = time.time() - conn.info['query_start_time'].pop(-1)
    if total > 1.0:  # 慢查询阈值
        logger.warning(f"慢查询: {statement[:100]} 耗时: {total:.2f}s")
```

## 5. 资源监控

### 5.1 系统资源

```python
import psutil
import time

def monitor_resources():
    while True:
        cpu_percent = psutil.cpu_percent(interval=1)
        memory = psutil.virtual_memory()
        disk = psutil.disk_usage('/')
        
        logger.info("系统资源", extra={
            'cpu_percent': cpu_percent,
            'memory_percent': memory.percent,
            'disk_percent': disk.percent
        })
        
        time.sleep(60)
```

## 6. 告警系统

### 6.1 告警规则

```python
from prometheus_client import AlertManager

def check_alerts():
    if cpu_percent > 80:
        send_alert("CPU使用率过高", cpu_percent)
    
    if memory_percent > 90:
        send_alert("内存使用率过高", memory_percent)
    
    if error_rate > 0.1:
        send_alert("错误率过高", error_rate)
```

## 7. 总结

监控与日志要点：
- **应用监控**：Prometheus、健康检查、指标收集
- **日志聚合**：ELK Stack、结构化日志
- **错误追踪**：Sentry、自定义错误追踪
- **性能监控**：APM、慢查询监控
- **资源监控**：CPU、内存、磁盘监控
- **告警系统**：告警规则、通知机制

完善的监控和日志系统保证应用稳定运行。

